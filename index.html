<!DOCTYPE html>
<html>
<head>
  <title>Ripley Rally Quiz</title>
  <link rel="stylesheet" href="style.css?v=2">
</head>
<body>

<!-- SNOWFALL LAYER -->
<div id="snowfall"></div>

<!-- COUNTDOWN -->
<div id="rallyCountdown" class="countdown"></div>

<!-- INTRO -->
<div id="intro">
  <h1>üéâ Welcome to the Ripley Rally üéâ</h1>
  <p>Unscramble this anagram to reveal today‚Äôs destination:</p>
  <p><b>WALTON ON THEM SA</b></p>
  <input id="anagram" placeholder="Enter destination">
  <button onclick="checkAnagram()">Submit</button>
</div>

<!-- TEAM NAME -->
<div id="team" class="hidden">
  <h2>Destination unlocked: Walton-on-Thames!</h2>
  <p>Enter your team name:</p>
  <input id="teamName">
  <button onclick="startQuiz()">Start Quiz</button>
</div>

<!-- QUIZ -->
<div id="quiz" class="hidden">
  <div class="timer">Time left: <span id="time">300</span> seconds</div>
  <div id="questionBox"></div>
</div>

<!-- RESULTS -->
<div id="results" class="hidden">
  <h2>üéâ Quiz Complete! üéâ</h2>
  <p id="score"></p>
  <button onclick="saveScore()">Save to Leaderboard</button>
  <button onclick="showLeaderboard()">View Leaderboard</button>
</div>

<!-- LEADERBOARD -->
<div id="leaderboard" class="hidden">
  <h2>üèÜ Leaderboard üèÜ</h2>
  <ul id="board"></ul>
  <button onclick="emailLeaderboard()">Email Leaderboard to Organiser</button>
</div>

<!-- AUDIO FILES -->
<audio id="startMusic" src="start.mp3"></audio>
<audio id="quizMusic" src="quiz.mp3" loop></audio>
<audio id="finaleMusic" src="finale.mp3"></audio>
<audio id="leaderboardMusic" src="leaderboard.mp3"></audio>
<audio id="deadlineMusic" src="deadline.mp3"></audio>

<script src="questions.js?v=3"></script>

<script>
window.onload = function() {

  // ============================
  // SNOWFALL EFFECT
  // ============================
  function startSnowfall() {
    const container = document.getElementById("snowfall");

    function createFlake() {
      const flake = document.createElement("div");
      flake.classList.add("snowflake");
      flake.innerHTML = "‚ùÑ";

      flake.style.left = Math.random() * 100 + "vw";
      flake.style.fontSize = (Math.random() * 10 + 10) + "px";
      flake.style.animationDuration = (Math.random() * 5 + 5) + "s";

      container.appendChild(flake);
      setTimeout(() => flake.remove(), 10000);
    }

    setInterval(createFlake, 200);
  }

  startSnowfall();


  // ============================
  // COUNTDOWN TO 25 DEC 12:00
  // ============================
  function startRallyCountdown() {
    const target = new Date();
    target.setMonth(11);
    target.setDate(25);
    target.setHours(12);
    target.setMinutes(0);
    target.setSeconds(0);
    target.setMilliseconds(0);

    function updateCountdown() {
      const now = new Date();
      const diff = target - now;

      if (diff <= 0) {
        document.getElementById("rallyCountdown").innerText = "üéÑ Deadline reached!";
        rallyDeadlineReached();
        return;
      }

      const hours = Math.floor(diff / (1000 * 60 * 60));
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const secs = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById("rallyCountdown").innerText =
        `‚è≥ Time until deadline: ${hours}h ${mins}m ${secs}s`;
    }

    updateCountdown();
    setInterval(updateCountdown, 1000);
  }

  function rallyDeadlineReached() {
    try { document.getElementById("deadlineMusic").play(); } catch(e) {}
    alert("üéÑ The Rally Deadline Has Arrived ‚Äî Welcome Home!");
  }


  // ============================
  // QUIZ STATE
  // ============================
  let current = 0, score = 0, team = "";
  let timer = 300;
  let quizInterval = null;


  // ============================
  // AUDIO HELPERS
  // ============================
  function play(id) {
    const el = document.getElementById(id);
    if (!el) return;
    try { el.currentTime = 0; el.play(); } catch(e) {}
  }

  function pause(id) {
    const el = document.getElementById(id);
    if (!el) return;
    try { el.pause(); } catch(e) {}
  }


  // ============================
  // CORE FLOW
  // ============================
  function checkAnagram(){
    let ans = document.getElementById("anagram").value.toLowerCase();
    if(ans.includes("walton-on-thames")){
      document.getElementById("intro").classList.add("hidden");
      document.getElementById("team").classList.remove("hidden");
      play("startMusic");
    } else { 
      alert("Try again!"); 
    }
  }

  function startQuiz(){
    team = document.getElementById("teamName").value;
    if(!team){
      alert("Please enter a team name!");
      return;
    }

    document.getElementById("team").classList.add("hidden");
    document.getElementById("quiz").classList.remove("hidden");

    pause("leaderboardMusic");
    pause("finaleMusic");
    play("quizMusic");

    showQuestion();

    timer = 300;
    document.getElementById("time").innerText = timer;

    if (quizInterval) clearInterval(quizInterval);
    quizInterval = setInterval(()=>{ 
      if(timer > 0){ 
        timer--; 
        document.getElementById("time").innerText = timer; 
      }
      else { 
        clearInterval(quizInterval);
        endQuiz(); 
      }
    },1000);
  }

  function showQuestion(){
    if(current >= questions.length){ 
      endQuiz(); 
      return; 
    }

    let q = questions[current];

    // BONUS QUESTION
    if (q.bonus) {
      document.getElementById("questionBox").innerHTML = `
        <div class='question'>
          <h3>${q.text}</h3>
          <button onclick='completeBonus()'>Mark Complete (+2)</button><br>
          <button onclick='skipBonus()'>Skip</button>
        </div>
      `;
      return;
    }

    // NORMAL QUESTION
    let html = `<div class='question'><h3>${q.q}</h3>`;
    q.options.forEach((opt,i)=>{
      html += `<button onclick='answer(${i})'>${opt}</button><br>`;
    });
    html += `</div>`;

    document.getElementById("questionBox").innerHTML = html;
  }

  function answer(i){
    if(i === questions[current].answer){ 
      score++; 
    }
    current++;
    showQuestion();
  }

  function completeBonus(){
    score += 2;
    current++;
    showQuestion();
  }

  function skipBonus(){
    current++;
    showQuestion();
  }

  function endQuiz(){
    pause("quizMusic");
    play("finaleMusic");

    if (quizInterval) clearInterval(quizInterval);

    document.getElementById("quiz").classList.add("hidden");
    document.getElementById("results").classList.remove("hidden");
    document.getElementById("score").innerText = 
      `Team: ${team} | Score: ${score}`;
  }

  function saveScore(){
    let board = JSON.parse(localStorage.getItem("ripleyBoard") || "[]");
    board.push({team:team, score:score});
    localStorage.setItem("ripleyBoard", JSON.stringify(board));
    alert("Score saved!");
  }

  function showLeaderboard(){
    pause("finaleMusic");
    play("leaderboardMusic");

    document.getElementById("results").classList.add("hidden");
    document.getElementById("leaderboard").classList.remove("hidden");
    let board = JSON.parse(localStorage.getItem("ripleyBoard") || "[]");
    board.sort((a,b)=>b.score - a.score);
    document.getElementById("board").innerHTML = board
      .map(e => `<li>${e.team}: ${e.score}</li>`)
      .join("");
  }


  // ============================
  // EMAIL LEADERBOARD
  // ============================
  function emailLeaderboard() {
    let board = JSON.parse(localStorage.getItem("ripleyBoard") || "[]");
    board.sort((a,b)=>b.score - a.score);

    let body = board.map(e => `${e.team}: ${e.score}`).join("%0D%0A");

    window.location.href =
      `mailto:rob1ripley@me.com?subject=Ripley Rally Leaderboard&body=${body}`;
  }


  // ============================
  // EXPOSE FUNCTIONS GLOBALLY
  // ============================
  window.checkAnagram = checkAnagram;
  window.startQuiz = startQuiz;
  window.saveScore = saveScore;
  window.showLeaderboard = showLeaderboard;
  window.emailLeaderboard = emailLeaderboard;

  window.answer = answer;
  window.showQuestion = showQuestion;
  window.endQuiz = endQuiz;
  window.completeBonus = completeBonus;
  window.skipBonus = skipBonus;

  // Start countdown
  startRallyCountdown();

}; // END window.onload
</script>

</body>
</html>
